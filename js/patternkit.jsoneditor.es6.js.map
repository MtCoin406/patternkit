{"version":3,"sources":["patternkit.jsoneditor.ts"],"names":[],"mappings":"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","file":"patternkit.jsoneditor.es6.js","sourcesContent":["/*globals Console:false */\n/*globals Drupal:false */\n/*globals jQuery:false */\n/*globals JSONEditor:false */\n/**\n * @file\n * Provides Twig Pattern Library Editing Functionality.\n *\n * @external Drupal\n *\n * @external jQuery\n *\n * @external JSONEditor\n *\n * @todo .editor-shadow-injection-target .card all: initial\n */\n\nimport {DrupalImageEditor} from \"./DrupalImageEditor\";\n\ndeclare global {\n  interface Window {\n    patternkitEditor:any;\n  }\n}\n\n(function ($, Drupal, JSONEditor) {\n  'use strict';\n\n  Drupal.behaviors.patternkitEditor = {\n    attach: function (context:any, settings:any) {\n      if (!window.JSONEditor) {\n        return;\n      }\n\n      // Ajax command response to allow updating Editor field values.\n      Drupal.AjaxCommands.prototype.patternkitEditorUpdate = function(ajax:any, response:any, status:any) {\n        window.patternkitEditor.getEditor(response.selector).setValue(response.value);\n      };\n\n      let saveSchema = function () {\n        $('#schema_instance_config').val(JSON.stringify(window.patternkitEditor.getValue()));\n        if (window.M) {\n          window.M.updateTextFields();\n        }\n      };\n\n      let $target = $('#editor-shadow-injection-target', context);\n      $target.once('patternkit-editor').each(function () {\n        let shadow = this.attachShadow({mode: 'open'});\n        let theme_js = settings.patternkitEditor.themeJS;\n        if (typeof theme_js === 'string') {\n          theme_js = [theme_js];\n        }\n        for (let i = 0; theme_js && i < theme_js.length; i++) {\n          let script_element = document.createElement('script');\n          script_element.type = \"text/javascript\";\n          script_element.src = theme_js[i];\n          document.getElementsByTagName('head')[0].appendChild(script_element);\n        }\n        let editor_dom = '';\n        if (settings.patternkitEditor.themeStylesheet) {\n          editor_dom = '<link rel=\"stylesheet\" id=\"theme_stylesheet\" href=\"' + settings.patternkitEditor.themeStylesheet + '\">';\n        }\n        // @todo Re-eval with this shadow dom webfont bug: https://bugs.chromium.org/p/chromium/issues/detail?id=336876\n        if (settings.patternkitEditor.iconStylesheet) {\n          let icons_element = document.createElement('link');\n          icons_element.rel = \"stylesheet\";\n          icons_element.id = \"icon_stylesheet\";\n          icons_element.href = settings.patternkitEditor.iconStylesheet;\n          document.getElementsByTagName('head')[0].appendChild(icons_element);\n          editor_dom += '<link rel=\"stylesheet\" id=\"icon_stylesheet\" href=\"' + settings.patternkitEditor.iconStylesheet + '\">';\n        }\n        editor_dom += '<div id=\"editor_holder\"></div>';\n        shadow.innerHTML += editor_dom;\n\n        let data = {\n          schema: JSON.parse(settings.patternkitEditor.schemaJson),\n          starting: JSON.parse(settings.patternkitEditor.startingJson)\n        };\n\n        JSONEditor.defaults.options.theme = settings.patternkitEditor.theme;\n        JSONEditor.defaults.options.iconlib = settings.patternkitEditor.icons;\n        JSONEditor.defaults.options.keep_oneof_values = false;\n        JSONEditor.defaults.options.disable_edit_json = true;\n        JSONEditor.defaults.options.disable_collapse = false;\n        JSONEditor.defaults.options.collapse = false;\n        JSONEditor.defaults.options.ajax = true;\n        JSONEditor.defaults.editors.drupal_image = new DrupalImageEditor(settings.patternkitEditor);\n        JSONEditor.defaults.resolvers.unshift(function(schema:any) {\n          if (schema.type === 'string' && schema.format === 'image') {\n            return 'drupal_image';\n          }\n        });\n\n        // Override how references are resolved.\n        JSONEditor.prototype._loadExternalRefs = function (schema:any, callback:Function) {\n          let refs = this._getExternalRefs(schema);\n\n          let done = 0, waiting = 0, callback_fired = false;\n\n          $.each(refs, (url:string) => {\n            if (this.refs[url]) {\n              return;\n            }\n            if (!this.options.ajax) {\n              throw \"Must set ajax option to true to load external ref \" + url;\n            }\n            this.refs[url] = 'loading';\n            waiting++;\n\n            let r = new XMLHttpRequest();\n            let uri = settings.path.baseUrl + url + '/schema';\n\n            r.open(\"GET\", uri, true);\n            r.onreadystatechange = () => {\n              if (r.readyState !== 4) {\n                return;\n              }\n              // Request succeeded.\n              if (r.status === 200) {\n                let response;\n                try {\n                  response = JSON.parse(r.responseText);\n                }\n                catch (e) {\n                  window.console.log(e);\n                  throw \"Failed to parse external ref \" + url;\n                }\n                if (!response || typeof response !== \"object\") {\n                  throw \"External ref does not contain a valid schema - \" + url;\n                }\n\n                this.refs[url] = response;\n                this._loadExternalRefs(response,function () {\n                  done++;\n                  if (done >= waiting && !callback_fired) {\n                    callback_fired = true;\n                    callback();\n                  }\n                });\n              }\n              // Request failed.\n              else {\n                window.console.log(r);\n                throw \"Failed to fetch ref via ajax- \" + url;\n              }\n            };\n            r.send();\n          });\n\n          if (!waiting) {\n            callback();\n          }\n        };\n\n        // Initialize the editor with a JSON schema.\n        let config = {\n          schema: data.schema,\n          refs: {},\n          startval: {}\n        };\n        if (typeof data.starting === 'object' && !$.isEmptyObject(data.starting)) {\n          config.startval = data.starting;\n        }\n        window.patternkitEditor = new JSONEditor($target[0].shadowRoot.getElementById('editor_holder'), config);\n        JSONEditor.plugins.sceditor.emoticonsEnabled = false;\n\n        window.patternkitEditor.on('ready', function () {\n          if (window.M) {\n            window.M.updateTextFields();\n          }\n        });\n        window.patternkitEditor.on('change', saveSchema);\n        // Drupal triggers Ajax submit via input events.\n        // This is before allowing other events, so we need to add a pre-hook\n        // to trigger the editor update with latest field values.\n        // @TODO Add handling for AJAX errors and re-attach.\n        let parent_call = Drupal.Ajax.prototype.beforeSubmit;\n        Drupal.Ajax.prototype.beforeSubmit = function (formValues:any, elementSettings:any, options:any) {\n          if (window.patternkitEditor) {\n            let index = formValues.findIndex(function (o:any) { return o.name === \"settings[instance_config]\"; });\n            if (index !== -1) {\n              window.patternkitEditor.disable();\n              saveSchema();\n              formValues[index] = {\n                name: \"settings[instance_config]\",\n                value: JSON.stringify(window.patternkitEditor.getValue()),\n                type: \"hidden\",\n                required: false\n              };\n              window.patternkitEditor.destroy();\n              delete window.patternkitEditor;\n            }\n          }\n          parent_call.call(this, formValues, elementSettings, options);\n        };\n        $('[data-drupal-selector=\"edit-actions-submit\"]').parent('form').once().each(function () {\n          $(this).on('submit', function (e) {\n            e.preventDefault();\n            window.patternkitEditor.disable();\n            saveSchema();\n            window.patternkitEditor.destroy();\n            delete window.patternkitEditor;\n            $(this).off('submit');\n          });\n        });\n      });\n    }\n  };\n})(jQuery, Drupal, JSONEditor);\n"]}